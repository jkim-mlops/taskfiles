version: '3'

env:
  TF_DIR: deployment
  VAR_FILE: terraform.tfvars

tasks:
  backend:
    desc: "Create backend.hcl file with proper configuration"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    vars:
      AWS_ACCOUNT_ID:
        sh: aws sts get-caller-identity --query Account --output text
      AWS_REGION:
        sh: aws configure get region --profile {{.AWS_PROFILE}}
      AWS_PROFILE: joe-dev
      TF_WORKSPACE:
        sh: terraform workspace show 2>/dev/null || echo "default"
      PROJECT_NAME:
        sh: basename {{.USER_WORKING_DIR}}
    cmds:
      - |
        cat > backend.hcl <<EOF
        bucket  = "terraform-state-{{.AWS_ACCOUNT_ID}}"
        key     = "{{.PROJECT_NAME}}/terraform.tfstate/{{.TF_WORKSPACE}}"
        region  = "{{.AWS_REGION}}"
        encrypt = true
        profile = "{{.AWS_PROFILE}}"

        # Remote state locking table
        dynamodb_table = "terraform-state-locks"
        EOF
      - echo "Created backend.hcl with bucket terraform-state-{{.AWS_ACCOUNT_ID}}"

  init:
    desc: "Initialize Terraform with backend configuration"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform init -backend-config=backend.hcl

  plan:
    desc: "Run Terraform plan"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform plan -var-file="{{.VAR_FILE}}"

  apply:
    desc: "Run Terraform apply"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform apply -var-file="{{.VAR_FILE}}"

  destroy:
    desc: "Run Terraform destroy"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform destroy -var-file="{{.VAR_FILE}}"

  docs:
    desc: "Generate Terraform documentation recursively"
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - |
        if [ ! -f .terraform-docs.yml ]; then
          if [ -d example ]; then
            cp {{.TASKFILE_DIR}}/templates/.terraform-docs.yml .terraform-docs.yml
            echo "Created .terraform-docs.yml (with example)"
          else
            cp {{.TASKFILE_DIR}}/templates/.terraform-docs-no-example.yml .terraform-docs.yml
            echo "Created .terraform-docs.yml (without example)"
          fi
        fi
      - |
        if [ -d modules ]; then
          terraform-docs markdown table --recursive --header-from main.tf --output-file README.md .
        else
          terraform-docs markdown table --header-from main.tf --output-file README.md .
        fi