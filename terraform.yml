version: '3'

env:
  TF_DIR: deployment

tasks:
  create-backend:
    desc: "Create backend.hcl file with proper configuration"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    vars:
      AWS_ACCOUNT_ID:
        sh: aws sts get-caller-identity --query Account --output text
      AWS_REGION:
        sh: aws configure get region --profile {{.AWS_PROFILE}}
      AWS_PROFILE: joe-dev
      TF_WORKSPACE:
        sh: terraform workspace show 2>/dev/null || echo "default"
    cmds:
      - |
        cat > backend.hcl <<EOF
        bucket  = "terraform-state-{{.AWS_ACCOUNT_ID}}"
        key     = "github-actions-runners/terraform.tfstate/{{.TF_WORKSPACE}}"
        region  = "{{.AWS_REGION}}"
        encrypt = true
        profile = "{{.AWS_PROFILE}}"

        # Remote state locking table
        dynamodb_table = "terraform-state-locks"
        EOF
      - echo "Created backend.hcl with bucket terraform-state-{{.AWS_ACCOUNT_ID}}"

  init:
    desc: "Initialize Terraform with backend configuration"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform init -backend-config=backend.hcl

  plan:
    desc: "Run Terraform plan"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform plan

  apply:
    desc: "Run Terraform apply"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform apply

  destroy:
    desc: "Run Terraform destroy"
    dir: '{{.USER_WORKING_DIR}}/{{.TF_DIR}}'
    cmds:
      - terraform destroy

  create-docs:
    desc: "Generate Terraform documentation recursively"
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - |
        if [ ! -f .terraform-docs.yml ]; then
          cat > .terraform-docs.yml <<'EOF'
        content: |-
          {{ .Header }}

          ## Example

          ```hcl
          {{ include "example/main.tf" }}
          ```

          {{ .Inputs }}

          {{ .Outputs }}
        EOF
          echo "Created .terraform-docs.yml"
        fi
      - terraform-docs markdown --recursive --output-file README.md .